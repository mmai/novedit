#Available tasks 
# buildgem : build the rubygem
# pkg/novedit.deb : build the Debian package

require 'lib/novedit'
require 'date'

require 'rake/gempackagetask'

pkg_name = $NAME.downcase

spec = Gem::Specification.new do |s|
  s.name = pkg_name
  s.version = $VERSION
  s.date = Date.today.to_s
  s.authors = $AUTHORS
  s.email = $EMAIL
  s.summary = $SUMMARY
  s.homepage = $HOMEPAGE
  s.description = $DESCRIPTION
  s.executables = ['novedit']
  s.files = FileList['*/**/*'].exclude("bacasable").exclude("features").exclude("pkg")
  s.required_ruby_version = '>=1.8.6'
  s.add_dependency('gettext')
  s.requirements = ["GTK+ 2.16", "libglade2 for ruby ('sudo apt-get install libglade2-ruby' on Debian based systems)"]
end

Rake::GemPackageTask.new(spec) do |package|
  package.need_zip = true
  package.need_tar = true
end

#gem_task : file task name generated by Rake::GemPackageTask
gem_task = "pkg/" + pkg_name + "-" + $VERSION + ".gem"

task :buildgem => gem_task 

# This task follows the tutorial found at http://blog.loftninjas.org/2008/10/01/debianizing-ruby-gems/
task :builddeb => :buildgem do |debfile|
  system "gem unpack " + gem_task
  workdir = gem_task[4..-5]
#  cp "/usr/lib/ruby/1.8/setup.rb ", workdir
  system "cp /usr/lib/ruby/1.8/setup.rb #{workdir}"
  mkdir workdir + "/debian"
  File.open(workdir + "/debian/changelog", "w") do |file|
    file << "#{pkg_name} (#$VERSION) unstable; urgency=low

  * Initial release.

 -- #$AUTHORS <#$EMAIL>  " + Time.now.strftime("%a, %d %b %Y %H:%M:%S %z")
  end

  File.open(workdir + "/debian/rules", "w") do |file|
    file << "#!/usr/bin/make -f
# copyright 2006 by Esteban Manchado Velazquez

include /usr/share/cdbs/1/rules/simple-patchsys.mk
include /usr/share/cdbs/1/rules/debhelper.mk
# Ruby package with setup.rb
include /usr/share/ruby-pkg-tools/1/class/ruby-setup-rb.mk" 
  end

  File.open(workdir + "/debian/control", "w") do |file|
    file << "Source: #{pkg_name}
Section: editors
Priority: optional
Maintainer: #$AUTHORS
Build-Depends: cdbs, debhelper (>> 5.0.0), ruby-pkg-tools, ruby1.8
Standards-Version: 3.8.0

Package: #{pkg_name}
Section: editors
Architecture: all
Depends: ruby1.8, libglade2-ruby
Homepage: #$HOMEPAGE
Description: #$SUMMARY
" 
#Depends: ruby1.8, libglade2-ruby, libgettext-ruby
#Depends: ruby1.8, libglade2-ruby, rubygems1.8
  end

  cd workdir
  system "dpkg-buildpackage -rfakeroot"
  cd ".."
  #Cleaning
  system "mv -f #{pkg_name}* pkg/debian"
  system "rm -rf #{pkg_name}-#$VERSION"
end
